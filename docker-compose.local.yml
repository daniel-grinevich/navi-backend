volumes:
  navi_backend_local_postgres_data: {}
  navi_backend_local_postgres_data_backups: {}
  minio_data: {}

services:
  django:
    build:
      context: .
      dockerfile: ./compose/local/django/Dockerfile
    image: navi_backend_local_django
    container_name: django
    depends_on:
      - postgres
      - redis
      - minio
    volumes:
      - .:/app:z
    env_file:
      - ./.envs/.local/.django
      - ./.envs/.local/.postgres
      - ./.envs/.local/.stripe
    ports:
      - "8000:8000"
      - "5678:5678"  # debugpy port
    environment:
      - DEBUGPY_ENABLED=${DEBUGPY_ENABLED:-0}  # Set to 1 to enable debugging
      - DEBUGPY_WAIT=${DEBUGPY_WAIT:-0}        # Set to 1 to wait for debugger before starting
    command: /start

  stripe:
    image: stripe/stripe-cli
    container_name: stripe
    command: "listen --api-key $${STRIPE_API_KEY} --device-name $${STRIPE_DEVICE_NAME} --forward-to django:8000/payment/webhook/"
    env_file:
      - ./.envs/.local/.stripe
    depends_on:
      - django
    volumes:
      - ./stripe-data:/root/.stripe

  postgres:
    build:
      context: .
      dockerfile: ./compose/production/postgres/Dockerfile
    image: navi_backend_production_postgres
    container_name: postgres
    volumes:
      - navi_backend_local_postgres_data:/var/lib/postgresql/data
      - navi_backend_local_postgres_data_backups:/backups
    env_file:
      - ./.envs/.local/.postgres

  redis:
    image: docker.io/redis:6
    container_name: redis

  celery_worker:
    build:
      context: .
      dockerfile: ./compose/local/django/Dockerfile
    image: navi_backend_local_django_celery
    depends_on:
      - postgres
      - redis
      - minio
    volumes:
      - .:/app:z
    env_file:
      - ./.envs/.local/.django
      - ./.envs/.local/.postgres
    command: /start-celeryworker

  celery_beat:
    build:
      context: .
      dockerfile: ./compose/local/django/Dockerfile
    image: navi_backend_local_django_beat
    depends_on:
      - postgres
      - redis
    volumes:
      - .:/app:z
    env_file:
      - ./.envs/.local/.django
      - ./.envs/.local/.postgres
    command: /start-celerybeat

  flower:
    build:
      context: .
      dockerfile: ./compose/local/django/Dockerfile
    image: navi_backend_local_django_flower
    depends_on:
      - postgres
      - redis
    volumes:
      - .:/app:z
    env_file:
      - ./.envs/.local/.django
      - ./.envs/.local/.postgres
    ports:
      - "5557:5555"
    command: /start-flower

  mailpit:
    image: axllent/mailpit
    container_name: mailpit
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI

  minio:
    image: quay.io/minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/minio/health/live || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio-init:
    image: quay.io/minio/mc:latest
    container_name: minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb --ignore-existing local/navi-local-media;
      mc anonymous set download local/navi-local-media;
      exit 0;
      "
